@{
    ViewData["Title"] = "Soporte en Vivo";
}

<style>
    /* Estilos para las burbujas de chat tipo WhatsApp */
    .chat-container {
        height: 400px;
        overflow-y: auto;
        background-color: #e5ddd5; /* Fondo tipo chat */
        padding: 15px;
        border-radius: 5px;
    }

    .message-bubble {
        max-width: 75%;
        padding: 10px 15px;
        border-radius: 15px;
        margin-bottom: 10px;
        position: relative;
        word-wrap: break-word;
    }

    /* Mensajes MÍOS (Derecha, Verde/Azul) */
    .message-me {
        background-color: #dcf8c6; /* Verde claro */
        color: #000;
        margin-left: auto; /* Empuja a la derecha */
        border-bottom-right-radius: 0;
    }

    /* Mensajes de OTROS (Izquierda, Blanco) */
    .message-other {
        background-color: #ffffff; /* Blanco */
        color: #000;
        margin-right: auto; /* Empuja a la izquierda */
        border-bottom-left-radius: 0;
    }

    .sender-name {
        font-size: 0.75rem;
        color: #999;
        margin-bottom: 3px;
        display: block;
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span>💬 Soporte Técnico Anónimo</span>
                    <span id="status" class="badge bg-warning text-dark">Conectando...</span>
                </div>

                <div id="chatBox" class="chat-container">
                    <ul id="messagesList" class="list-unstyled d-flex flex-column">
                    </ul>
                </div>

                <div class="card-footer bg-white">
                    <div class="input-group">
                        <input type="hidden" id="userInput" value="@User.Identity?.Name" />

                        <input type="text" id="messageInput" class="form-control" placeholder="Escribe un mensaje..." autocomplete="off" />
                        <button id="sendButton" class="btn btn-primary">
                            Enviar ✈️
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>
    var connection = new signalR.HubConnectionBuilder().withUrl("/chathub").build();

    document.getElementById("sendButton").disabled = true;

    // Ahora recibimos 3 parámetros: user (el nombre falso), message y senderId
    connection.on("ReceiveMessage", function (user, message, senderId) {
        var li = document.createElement("li");

        // LÓGICA NUEVA: Comparamos IDs de conexión, no nombres
        // connection.connectionId es MI identificador actual en el socket
        var isMe = senderId === connection.connectionId;

        if (isMe) {
            // ES MÍO -> Derecha (Verde)
            li.className = "message-bubble message-me align-self-end";
            li.innerHTML = `<strong>${message}</strong>`;
        } else {
            // ES DE OTRO -> Izquierda (Blanco)
            // Aquí mostramos el nombre anonimizado que viene del servidor
            li.className = "message-bubble message-other align-self-start";
            li.innerHTML = `<span class="sender-name">${user}</span>${message}`;
        }

        document.getElementById("messagesList").appendChild(li);

        // Scroll al fondo
        var chatBox = document.getElementById("chatBox");
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    connection.start().then(function () {
        document.getElementById("sendButton").disabled = false;
        var statusBadge = document.getElementById("status");
        statusBadge.innerText = "Conexión Segura Activa";
        statusBadge.classList.remove("bg-warning", "text-dark");
        statusBadge.classList.add("bg-success", "text-white");
    }).catch(function (err) {
        return console.error(err.toString());
    });

    // Enviar al hacer clic
    document.getElementById("sendButton").addEventListener("click", function (event) {
        sendMessage();
        event.preventDefault();
    });

    // Enviar al presionar Enter
    document.getElementById("messageInput").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            sendMessage();
            event.preventDefault();
        }
    });

    function sendMessage() {
        var message = document.getElementById("messageInput").value;

        if(message.trim() !== ""){
            // YA NO enviamos el usuario, solo el mensaje
            connection.invoke("SendMessage", message).catch(function (err) {
                return console.error(err.toString());
            });
            document.getElementById("messageInput").value = "";
        }
    }
</script>